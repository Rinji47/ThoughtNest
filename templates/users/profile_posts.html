{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}My Posts - ThoughtNest{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user_profile.css' %}">
{% endblock %}

{% block content %}

<div class="profile-wrapper">
    {% include 'users/profile_sidebar.html' %}

    <main class="profile-content">
        
        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <section class="section-container">
            <div class="posts-section-header">
                <a href="{% url 'post_create' %}" class="btn-new-post">
                    <i class="fa-solid fa-plus"></i> New Post
                </a>
            </div>

            <!-- Filters -->
            <form method="get" class="posts-filter-form">
                <div class="filter-row">
                    <input type="text" name="q" placeholder="Search posts..." value="{{ search_query }}" class="filter-input">
                    
                    <div class="filter-select-grid">
                        <select name="category" class="filter-select">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if selected_category|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                        <select name="status" class="filter-select">
                            <option value="">All Posts</option>
                            <option value="published" {% if selected_status == 'published' %}selected{% endif %}>Published</option>
                            <option value="draft" {% if selected_status == 'draft' %}selected{% endif %}>Draft</option>
                        </select>
                        <select name="date_range" class="filter-select">
                            <option value="">All Time</option>
                            <option value="today" {% if selected_date_range == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if selected_date_range == 'week' %}selected{% endif %}>Last 7 Days</option>
                            <option value="month" {% if selected_date_range == 'month' %}selected{% endif %}>Last 30 Days</option>
                            <option value="year" {% if selected_date_range == 'year' %}selected{% endif %}>Last Year</option>
                        </select>
                        <select name="order_by" class="filter-select">
                            <option value="-created_at" {% if selected_order == '-created_at' %}selected{% endif %}>Newest First</option>
                            <option value="created_at" {% if selected_order == 'created_at' %}selected{% endif %}>Oldest First</option>
                            <option value="-updated_at" {% if selected_order == '-updated_at' %}selected{% endif %}>Recently Updated</option>
                            <option value="title" {% if selected_order == 'title' %}selected{% endif %}>Title (A-Z)</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="btn-filter"><i class="fa-solid fa-search"></i> Apply</button>
                        {% if search_query or selected_category or selected_status or selected_date_range %}
                            <a href="{% url 'user_manage_posts' %}" class="btn-filter btn-filter-clear"><i class="fa-solid fa-redo"></i> Clear</a>
                        {% endif %}
                    </div>
                </div>
            </form>

            {% if posts %}
                <p class="posts-found-count">Found <strong>{{ posts.count }}</strong> post{% if posts.count != 1 %}s{% endif %}</p>
                <div class="user-posts-grid">
                    {% for post in posts %}
                    <div class="user-post-card">
                        <div class="user-post-card-image">
                            {% if post.featured_image %}
                                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
                            {% else %}
                                <i class="fa-solid fa-image"></i>
                            {% endif %}
                        </div>
                        <div class="user-post-card-body">
                            <div class="user-post-card-badges">
                                {% if post.category %}
                                    <span class="badge-category">{{ post.category.name }}</span>
                                {% endif %}
                                <span class="badge-status {% if post.status == 'published' %}badge-published{% else %}badge-draft{% endif %}">
                                    {{ post.get_status_display }}
                                </span>
                            </div>
                            <h3 class="user-post-card-title">
                                <a href="{% url 'post_detail' post.pk %}">{{ post.title }}</a>
                            </h3>
                            <p class="user-post-card-excerpt">{{ post.content|truncatewords:20 }}</p>
                            <div class="user-post-card-stats">
                                <span><i class="fa-solid fa-calendar"></i> {{ post.created_at|date:"M d, Y" }}</span>
                                <span><i class="fa-solid fa-heart"></i> {{ post.likes.count }}</span>
                                <span><i class="fa-solid fa-comment"></i> {{ post.comments.count }}</span>
                            </div>
                            {% if post.tags.all %}
                            <div class="user-post-card-tags">
                                {% for tag in post.tags.all %}
                                    <a href="{% url 'categories' %}?tag={{ tag.slug }}">#{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="user-post-card-actions">
                                <a href="{% url 'edit_post' post.pk %}" class="btn-edit"><i class="fa-solid fa-pen-to-square"></i> Edit</a>
                                <form method="post" action="{% url 'post_delete' post.pk %}" class="inline-form" onsubmit="return confirm('Delete this post?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-delete"><i class="fa-solid fa-trash"></i> Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="posts-empty-state">
                    <i class="fa-solid fa-feather"></i>
                    {% if search_query or selected_category or selected_status or selected_date_range %}
                        <p>No posts found matching your filters.</p>
                        <a href="{% url 'user_manage_posts' %}" class="btn-filter">
                            <i class="fa-solid fa-redo"></i> Clear Filters
                        </a>
                    {% else %}
                        <p>You haven't created any posts yet.</p>
                        <a href="{% url 'post_create' %}" class="btn-new-post">
                            <i class="fa-solid fa-plus"></i> Create Your First Post
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </section>
    </main>
</div>

{% endblock %}