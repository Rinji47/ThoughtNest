{% extends "base.html" %}
{% load static %}

{% block title %}
{% if mode == 'edit' %}Edit Post - ThoughtNest{% else %}New Post - ThoughtNest{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
<style>
    /* Tag search dropdown styling */
    #tagSearchSuggestions div:hover {
        background: #e8d6c1;
    }

    /* Ensure form field height increase applies even when static CSS is cached */
    #postTitle,
    #postCategory,
    #postTags,
    #postStatus {
        min-height: 56px !important;
        padding: 0.85rem 1rem !important;
    }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<div class="container">
    <div class="post-form-wrapper">
        <a href="javascript:history.back()" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Go Back
        </a>

        <h1 class="page-title">
            {% if mode == 'edit' %}
            <i class="fa-solid fa-pen-to-square" style="color:var(--accent-color);font-size:0.85em;"></i> Edit Post
            {% else %}
            <i class="fa-solid fa-pen-nib" style="color:var(--accent-color);font-size:0.85em;"></i> Create New Post
            {% endif %}
        </h1>

        <form method="post" class="post-form" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-group">
                <label for="postTitle">Post Title</label>
                <input type="text" id="postTitle" name="title" value="{% if post %}{{ post.title }}{% endif %}" required
                    placeholder="Give your post a compelling title">
            </div>

            <div class="form-group">
                <label for="postCategory">Category</label>
                <select id="postCategory" name="category">
                    <option value="">Select a category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="postTags">Tags <span style="font-weight:400;color:var(--text-faint);">(comma-separated)</span></label>
                <input type="text" id="postTags" name="tags"
                    value="{% if post %}{% for tag in post.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}"
                    placeholder="e.g. technology, design, lifestyle">
                
                <!-- Popular Tags -->
                {% if popular_tags %}
                <div class="popular-tags" style="margin-top:0.5rem;">
                    <span class="popular-tags-label">Popular tags</span>
                    <div class="popular-tags-list" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.3rem;">
                        {% for tag in popular_tags %}
                        <button type="button" class="tag-chip" data-tag="{{ tag.name }}">{{ tag.name }}</button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Tag Search -->
				{% if all_tag_names %}
				{{ all_tag_names|json_script:"allTagsData" }}
				<div class="tag-search-wrapper" style="margin-top:0.7rem; position:relative;">
					<input type="text" id="tagSearchInput" placeholder="Search tags..."
						style="width:100%; min-height:56px; padding:0.85rem 1rem; border-radius:12px; border:1px solid #f2e5d7; background:#fffaf5; color:#7a6a5a;">
					<div id="tagSearchSuggestions" style="position:absolute; top:100%; left:0; width:100%; background:#fffaf5; border:1px solid #f2e5d7; border-radius:12px; max-height:200px; overflow-y:auto; z-index:10;"></div>
				</div>
				{% endif %}
            </div>

            <div class="form-group">
                <label for="postStatus">Publish Status</label>
                <select id="postStatus" name="status">
                    <option value="published" {% if post and post.status == 'published' %}selected{% endif %}>Published</option>
                    <option value="draft" {% if post and post.status == 'draft' %}selected{% endif %}>Draft</option>
                </select>
            </div>

            <div class="form-group">
                <label for="postContent">Content</label>
                <textarea id="postContent" name="content" rows="12" required placeholder="Write your post here">{% if post %}{{ post.content }}{% endif %}</textarea>
            </div>

            <button type="submit" class="btn-primary btn-lg">
                {% if mode == 'edit' %}
                <i class="fa-solid fa-floppy-disk"></i> Save Changes
                {% else %}
                <i class="fa-solid fa-paper-plane"></i> Publish Post
                {% endif %}
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const allTags = JSON.parse(document.getElementById('allTagsData').textContent);
    const tagInput = document.getElementById('postTags');

    const searchInput = document.getElementById('tagSearchInput');
    const suggestionsContainer = document.getElementById('tagSearchSuggestions');

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.toLowerCase().trim();
        suggestionsContainer.innerHTML = '';
        if (!query) return;

        const matches = allTags.filter(tag => tag.toLowerCase().includes(query)).slice(0, 10);

        if (matches.length === 0) {
            const div = document.createElement('div');
            div.textContent = "No tags found";
            div.style.padding = '0.3rem 0.5rem';
            div.style.color = '#a18f7d';
            suggestionsContainer.appendChild(div);
            return;
        }

        matches.forEach(tag => {
            const div = document.createElement('div');
            div.textContent = tag;
            div.style.cursor = 'pointer';
            div.style.padding = '0.3rem 0.5rem';
            div.style.background = '#fffaf5';
            div.style.borderBottom = '1px solid #f2e5d7';
            div.addEventListener('click', () => {
                let current = tagInput.value.split(',').map(t => t.trim()).filter(t => t);
                if (!current.includes(tag)) {
                    current.push(tag);
                }
                tagInput.value = current.join(', ');
                searchInput.value = '';
                suggestionsContainer.innerHTML = '';
            });
            suggestionsContainer.appendChild(div);
        });
    });

    document.addEventListener('click', (e) => {
        if (!suggestionsContainer.contains(e.target) && e.target !== searchInput) {
            suggestionsContainer.innerHTML = '';
        }
    });

    document.querySelectorAll('.tag-chip').forEach(button => {
        button.addEventListener('click', () => {
            const tag = button.dataset.tag;
            let current = tagInput.value.split(',').map(t => t.trim()).filter(t => t);
            if (!current.includes(tag)) {
                current.push(tag);
            }
            tagInput.value = current.join(', ');
        });
    });
});
</script>
{% endblock %}
